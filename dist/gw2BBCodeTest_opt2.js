(function(window) {var e=!0,q=null,r=!1;Task=function(){this.status=0;this.k=this.o=this.A=q};Task.prototype.D=function(){return 2===this.status};Task.prototype.error=function(a){this.o=a;return this};Task.prototype.success=function(a){this.k=a;return this};function t(a){if(!a.D()){if((a.A||q)==q)throw Error("workFn not defined");if((a.o||q)==q)throw Error("errorFn not defined");if((a.k||q)==q)throw Error("successFn not defined");a.status=1;a.A(a)}};JSONTask=function(a){this.url=a||"";this.data=q;this.A=function(){var a=this;jQuery.getJSON(this.url).success(function(c){a.status=2;a.data=c;a.k(a)}).error(function(c,g){a.status=-1;a.o(a,"Error while retrieving data from "+a.url+" . ("+g+")")})}};JSONTask.prototype=new Task;TaskList=function(){this.timeout=1E3*("undefined"!==typeof tasksTimeout?tasksTimeout:15);this.h=[];var a=q;this.clear=function(){this.h=[];this.status=0};this.ea=function(b){var c=this;this.h.push(b.success(function(){-1!==c.status&&c.D()&&(clearTimeout(a),c.status=2,c.k(c))}).error(function(b){clearTimeout(a);c.status=-1;c.o(c,"Error while retrieving data. ("+b+")")}))};this.A=function(){var b=this,c=0;this.timeout!==q&&0<this.timeout&&(a=setTimeout(function(){b.status=-1;throw Error("TaskList: timeout reached.");
},this.timeout));for(c=0;c<this.h.length;c++)t(this.h[c]);0===this.h.length&&this.k(this)};this.D=function(){for(var a=0;a<this.h.length;a++)if(!this.h[a].D())return r;return e}};TaskList.prototype=new Task;function u(){return"undefined"!==typeof Storage&&"undefined"!==JSON}function v(a,b,c,g){b={data:b,ver:Math.max(1,c||0),ttl:Math.max(0,g||0),created:Date.now()};localStorage.setItem(a,JSON.stringify(b))}function w(a,b){var c=JSON.parse(localStorage.getItem(a));return this.Ca(c,b)?c.data:q}function x(){return localStorage.getItem("obj")!==q};Gw2BBCodeGlobal=function(){this.P="https://s3-eu-west-1.amazonaws.com/gw2bbcode.pl/NEXT/";this.T="https://s3-eu-west-1.amazonaws.com/gw2bbcode.pl/gw2_images";this.sa="https://s3-eu-west-1.amazonaws.com/gw2bbcode.pl/tooltip.css";this.la="https://s3-eu-west-1.amazonaws.com/gw2bbcode.pl/gw2BBCode.css";this.r={url:this.P+"main_resource_pack.json",ver:2};this.ca=["air","earth","fire","water"];this.Z="el en gu me ne ra th wa".split(" ");this.Ia="Elementalist Engineer Guardian Mesmer Necromancer Ranger Thief Warrior".split(" ");
this.da=["skill","trait","boon","condition"];this.d=[{url:this.P+"lang_pack_fr.json",ver:1,lang:"fr"}];this.C={s:"skills",tr:"traits",b:"boons",co:"conditions"};this.ka="http://wiki.guildwars2.com/wiki";this.ja="http://www.gw2db.com";this.W="gw2DB"};LoadResourceTask=function(a,b,c){this.data=q;this.za=c;this.version=b;this.I=a;this.A=function(){var a=this,b=q,c=q;u()&&(b=w(this.I,this.version));b!==q?(a.status=2,a.data=b.data,a.k(a)):(c=(new JSONTask(this.I)).success(function(f){a.data=f.data;v(a.I,a.data,a.version,a.za);a.status=2;a.k(a)}).error(function(f,b){a.status=-1;a.o(a,b)}),t(c))}};LoadResourceTask.prototype=new Task;ResourceManager=function(){this.Ea=function(){};this.na=function(a,b){if(a===q||0===a.length)b(a);else{var c=new TaskList,g=0;c.aa=a;c.fa=b;for(g=0;g<a.length;g++)c.ea(new LoadResourceTask(a[g].url,a[g].ver||1,a[g].ttl||0));c.success(function(a){for(var b=0;b<a.h.length;b++)a.aa[b].data=a.h[b].data;a.fa(a.aa)}).error(function(a,b){throw Error(b);});t(c)}};this.K=function(a,b){return u()&&w(a,b)!==q};this.Ba=function(a){var b;for(b=0;b<a.length;b++)if(!this.K(a[b].url,a[b].ver))return r;return e};
this.i=function(a,b){return w(a,b)};this.$=function(a,b){v(a,b,1,0)}};NoLocalStorageResourceManager=function(){this.Ja={};this.i=function(){};this.Aa=function(){}};function y(a,b,c,g){for(var h=0,d=0,f=q,l="",h=0;h<c.length;h++)l+=c[h]+"|";for(h=0;h<a.d.length;h++)if(f=b.i(a.d[h].url,a.d[h].ver),f!==q)for(d=0;d<f.B[g].length;d++)-1===l.indexOf(f.B[g][d])&&(l+=f.B[g][d]+"|");return l.slice(0,l.length-1)}
function z(a,b,c,g,h){if(""===c)return"";var d=0,f=0,l=q;c=c.toLowerCase();for(d=0;d<g.length;d++)if(c===g[d].toLowerCase())return g[d];for(d=0;d<a.d.length;d++)if(l=b.i(a.d[d].url,a.d[d].ver),l!==q)for(f=0;f<l.B[h].length&&f<g.length;f++)if(c===l.B[h][f].toLowerCase())return g[f];return""};BBCodeDataEntry=function(a){this.name=a;this.F=this.f=q;this.q=function(){return this.f!==q&&"m"===this.f.t};this.Q=[];this.S=function(a){if(this.q())for(var c=0;c<this.f.m.length;c++)this.Q.push(a.g[this.f.m[c]])}};
BBCodeData=function(a,b){this.j=a;this.v=b;this.Ha="gw2BBCode";this.M="";this.c=this.a=q;this.U=this.w=r;this.z="";this.G=-1;this.u=this.type="";this.Da=function(){return this.a!==q&&this.c!==q};this.toString=function(){return"regex: "+this.M+"<br>name1: "+this.Fa+"<br>name2: "+this.Ga+"<br>showAsText: "+this.w+"<br>isPrefixed: "+this.U+"<br>stance: "+this.z+"<br>forcedIdx: "+this.G+"<br>type: "+this.type+"<br>prof: "+this.u+"<br><br>"};this.xa=function(c){this.z=z(a,b,c,a.ca,"stance")};this.ya=function(c){this.type=
z(a,b,c,a.da,"types")};this.wa=function(c){this.u=z(a,b,c,a.Z,"prof")};this.ma=function(){return this.a===q&&this.c!==q||this.a!==q&&(this.a.f===q||this.a.f===q)||this.c!==q&&(this.c.f===q||this.c.f===q)?r:e}};ClassicPattern=function(a,b){var c=RegExp("\\[([@^_]*)(gw2:)?(("+y(a,b,a.Z,"prof")+"):)?(("+y(a,b,a.da,"types")+"):)?(.*?)(\\|(.*?))?(:("+y(a,b,a.ca,"stance")+"))?(\\.(\\d+))?\\]","gi");this.ta=function(g){for(var h=[],d=c.exec(g),f=q;d!==q;)f=new BBCodeData(a,b),f.M=RegExp((d[0]||"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),"gi"),f.w=-1!==(d[1]||"").indexOf("@"),f.U="gw2:"===(d[2]||"").toLowerCase(),f.wa(d[4]||""),f.ya(d[6]||""),f.a=d[7]?new BBCodeDataEntry(d[7]):q,f.c=d[9]?new BBCodeDataEntry(d[9]):
q,f.xa(d[11]||""),f.G=Math.max(1,d[13]||1),d=c.exec(g),h.push(f);return h}};PatternFinders=function(a){this.N=[];this.va=function(a){this.N.push(a)};this.find=function(b){for(var c=[],g=0,h=0,d,g=0;g<this.N.length;g++){d=this.N[g].ta(b);for(h=0;h<d.length;h++)c.push(d[h])}for(g=0;g<c.length;g++)a.ha(c[g]);return c}};Gw2DBCOMGenerator=function(a){function b(a,b){var c=a.names[b];return c?c:a.names.en||""}function c(b,c,k){return"tr"===b?"<img src='{0}/{1}/{2}.png'>".l(a.T,a.C[b],c):"<img src='{0}/{1}/{2}.png'>".l(a.T,a.C[b],k)}function g(b,c,k,d){return"<a href='{0}' class='gw2DBTooltip gw2DB_{1}_{2}'>{3}</a>".l("gw2Wiki"===a.W?"{0}/{1}".l(a.ka,c.replace(/\s/g,"-").replace(/['"!]/g,"")):"gw2DB"===a.W?"{0}/{1}/{2}".l(a.ja,a.C[k],b):"#",a.C[k],b,d)}function h(a,l){var k,d=[],j=q,h="",n="";for(k=0;k<a.f.m.length;k++)j=
a.Q[k],h=b(j,a.F.lang),d.push(g(j.id,h,j.t,l.w?h:c(j.t,j.tr||"",j.id)));for(k=0;k<d.length;k++)n+=d[k]+(l.w&&k!==d.length-1?" ":"");return n}function d(a,l){var k=a.f,d=b(k,a.F.lang);return g(k.id,d,k.t,l.w?d:c(k.t,k.tr||"",k.id))}this.ia=function(a){var b="";a.a!==q&&!a.a.q()?b=d(a.a,a):a.a!==q&&a.a.q()&&(b=h(a.a,a));a.c!==q&&!a.c.q()?d(a.c,a):a.c!==q&&a.c.q()&&h(a.c,a);return b}};HTMLProcessor=function(a,b){var c="html,head,style,title,link,meta,script,object,iframe,code,textarea,a",c=c+",";this.ua=function(){this.X(document.body)};this.X=function(g){if(!(g===q||"undefined"==g)){g=g.childNodes;for(var h=0,d=q,f=q,h=0;h<g.length;h++)if(f=g[h],1===f.nodeType&&-1===(c+",").indexOf(f.nodeName.toLowerCase()+",")&&this.X(f),!(3!==f.nodeType||""===(f.data||"").trim()))if(d=b.find(f.data),0!==d.length){for(var l=a,k=f.parentNode,p=d.length,j=f.data,m=0,n=q,n=m=q,m=0;m<p;m++)n=d[m],
n.ma()&&(j=j.replace(n.M,l.ia(n)));if(j!==f.data){m=document.createElement("div");n=document.createDocumentFragment();for(m.innerHTML=j;m.firstChild;)n.appendChild(m.firstChild);k.insertBefore(n,f);k.removeChild(f)}}}}};Gw2DataMap=function(a,b,c){function g(a,b){return a.n===b.n?0<a.id&&0<b.id||0>a.id&&0>b.id?a.id>b.id?-1:1:0<a.id?-1:1:a.oa>b.oa?1:-1}function h(a){return"gw2_"+a.substr(0,3).toLowerCase()}function d(a,b,c){var d,f,g=0,s=q,C=b.toLowerCase();if(""===b)return q;d=a.e[h(b)]||q;if(d===q)return q;for(f=0;f<d.length;f++)if(d[f].n.toLowerCase()===C){s=a.g[d[f].id]||q;if(s===q)throw Error("no data for "+b);if((""!==c.z&&c.z.toLowerCase()===(s.st||"").toLowerCase()||""===c.z)&&(""!==c.type&&c.type.toLowerCase()===
(s.t||"").toLowerCase()||""===c.type)&&(""!==c.u&&c.u.toLowerCase()===(s.p||"").toLowerCase()||""===c.u)&&++g===c.G)return{data:s,name:d[f]}}return q}this.g={};this.e={};var f=e;this.J=function(c){var d=0;b.K(a.r.url,a.r.ver)||(f=r,c.push(a.r));for(d=0;d<a.d.length;d++)b.K(a.d[d].url,a.d[d].ver)||(f=r,c.push(a.d[d]))};this.J(c);this.ha=function(a){var b=q;a.a!==q&&(b=d(this,a.a.name,a),b!==q&&(a.a.f=b.data,a.a.F=b.name,a.a.S(this)));a.c!==q&&(b=d(this,a.c.name,a),b!==q&&(a.c.f=b.data,a.c.F=b.name,
a.c.S(this)))};this.ga=function(){f===e&&(this.g=b.i("Gw2DataMap",1),this.e=b.i("Gw2NameMap",1),f=this.g!==q&&this.e!==q);if(!f){var c,d,p=q,j,m;this.g={};this.e={};p=b.i(a.r.url,a.r.ver);for(c=0;c<p.length;c++)j=p[c],j.names={en:j.n},this.g[j.id]=j,this.e[h(j.n)]=this.e[h(j.n)]||[],this.e[h(j.n)].push({id:j.id,n:j.n,lang:"en"});for(c=0;c<a.d.length;c++){p=b.i(a.d[c].url,a.d[c].ver);for(d=0;d<p.pa.length;d++){j=p.pa[d];if((this.g[j[0]]||q)===q)console.log("ERROR: no data for id:{0}, name:{1} in langPack:{2}".l(j[0],
j[1],p.lang)),this.g[j[0]]={id:j[0],name:j[1],t:"?",names:{}};this.e[h(j[1])]=this.e[h(j[1])]||[];this.e[h(j[1])].push({id:j[0],n:j[1],lang:p.lang});this.g[j[0]].names[p.lang]=j[1]}}for(m in this.e)-1!==m.indexOf("gw2_")&&this.e[m].sort(g);b.$("Gw2DataMap",this.g);b.$("Gw2NameMap",this.e);f=e}}};Gw2BBCode=function(){this.ba=this.R=r;this.j=this.H=this.O=this.Y=this.L=this.v=q;this.J=function(){this.j=new Gw2BBCodeGlobal;if(u())this.v=new ResourceManager;else throw Error("not implmeneted yet");var a=[],b=this;A(this.j.la);A(this.j.sa);this.H=new Gw2DataMap(this.j,this.v,a);this.L=new PatternFinders(this.H);this.O=new Gw2DBCOMGenerator(this.j);this.Y=new HTMLProcessor(this.O,this.L);this.v.na(a,function(){b.ra()});jQuery(document).ready(function(){b.qa()})};this.ra=function(){this.ba=e;this.H.ga();
this.L.va(new ClassicPattern(this.j,this.v));this.V()};this.qa=function(){this.R=e;this.V()};this.V=function(){this.ba&&this.R&&this.Y.ua()}};localStorage.clear();window.gw2BBCode=new Gw2BBCode;window.gw2BBCode.J();console.log("isLocalStorageSupported: ",u());console.log("containsKey: ",x());console.log("putObject: ",v("obj",{one:1,two:2,three:3}));console.log("containsKey: ",x());console.log("getObject: ",w("obj"));console.log("containsKey: ",x());console.log("remove: ",function(a){localStorage.removeItem(a)}("obj"));console.log("containsKey: ",x());var B=new TaskList;B.success(function(){console.log("AsyncTaskList: done")});B.error(function(a,b){console.log("Error "+b)});t(B);function A(a){var b=document.createElement("link");b.rel="stylesheet";b.type="text/css";b.href=a;b.media="all";document.getElementsByTagName("head")[0].appendChild(b)}String.prototype.l=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})};})(window);
