(function(window) {function loadStyle(a){var c=document.createElement("link");c.rel="stylesheet";c.type="text/css";c.href=a;c.media="all";document.getElementsByTagName("head")[0].appendChild(c)}function compareStrLow(a,c){return a.toLowerCase()===c.toLowerCase()}String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(c,b){return"undefined"!=typeof a[b]?a[b]:c})};Task=function(){this.status=0;this.successFn=this.errorFn=this.workFn=null};Task.prototype.isDone=function(){return 2===this.status};Task.prototype.error=function(a){this.errorFn=a;return this};Task.prototype.success=function(a){this.successFn=a;return this};
Task.prototype.doWork=function(){if(!this.isDone()){if(null==(this.workFn||null))throw Error("workFn not defined");if(null==(this.errorFn||null))throw Error("errorFn not defined");if(null==(this.successFn||null))throw Error("successFn not defined");this.status=1;this.workFn(this)}};JSONTask=function(a){this.url=a||"";this.data=null;this.workFn=function(){var a=this;jQuery.getJSON(this.url).success(function(b){a.status=2;a.data=b;a.successFn(a)}).error(function(b,d){a.status=-1;a.errorFn(a,"Error while retrieving data from "+a.url+" . ("+d+")")})}};JSONTask.prototype=new Task;TaskList=function(){this.timeout=1E3*("undefined"!==typeof tasksTimeout?tasksTimeout:15);this.tasks=[];var a=null;this.clear=function(){this.tasks=[];this.status=0};this.addTask=function(c){var b=this;this.tasks.push(c.success(function(){-1!==b.status&&b.isDone()&&(clearTimeout(a),b.status=2,b.successFn(b))}).error(function(c){clearTimeout(a);b.status=-1;b.errorFn(b,"Error while retrieving data. ("+c+")")}))};this.workFn=function(){var c=this,b=0;null!==this.timeout&&0<this.timeout&&(a=setTimeout(function(){c.status=
-1;throw Error("TaskList: timeout reached.");},this.timeout));for(b=0;b<this.tasks.length;b++)this.tasks[b].doWork();0===this.tasks.length&&this.successFn(this)};this.isDone=function(){for(var a=0;a<this.tasks.length;a++)if(!this.tasks[a].isDone())return!1;return!0}};TaskList.prototype=new Task;function LocalStorageHelper(){}LocalStorageHelper.isSupported=function(){return"undefined"!==typeof Storage&&"undefined"!==JSON};LocalStorageHelper.putObject=function(a,c,b,d){c={data:c,ver:Math.max(1,b||0),ttl:Math.max(0,d||0),created:Date.now()};localStorage.setItem(a,JSON.stringify(c))};LocalStorageHelper.getObject=function(a,c){var b=JSON.parse(localStorage.getItem(a));return this.isValid(b,c)?b.data:null};LocalStorageHelper.containsKey=function(a){return null!==localStorage.getItem(a)};
LocalStorageHelper.remove=function(a){localStorage.removeItem(a)};LocalStorageHelper.clear=function(){localStorage.clear()};LocalStorageHelper.isValid=function(a,c){return null!==a&&a.ver===c&&(0===a.ttl||0!==a.ttl&&a.created+a.ttl<Date.now())};LocalStorageHelper.isUpToDate=function(a,c){return null!==LocalStorageHelper.getObject(a,c)};Gw2BBCodeGlobal=function(){this.imagesUrl="https://s3-eu-west-1.amazonaws.com/gw2bbcode.pl/gw2_images";this.contentUrl="https://s3-eu-west-1.amazonaws.com/gw2bbcode.pl/NEXT/";this.popup_cssURL="https://s3-eu-west-1.amazonaws.com/gw2bbcode.pl/tooltip.css";this.gw2_cssURL="https://s3-eu-west-1.amazonaws.com/gw2bbcode.pl/gw2BBCode.css";this.main_pack={url:this.contentUrl+"main_resource_pack.json",ver:2};this.stances_langEn=["air","earth","fire","water"];this.prof_s_langEn="el en gu me ne ra th wa".split(" ");
this.prof_l_langEn="Elementalist Engineer Guardian Mesmer Necromancer Ranger Thief Warrior".split(" ");this.types_langEn=["skill","trait","boon","condition"];this.lang_packs=[{url:this.contentUrl+"lang_pack_fr.json",ver:1,lang:"fr"}];this.element_type={s:"skills",tr:"traits",b:"boons",co:"conditions"};this.gw2WikiUrl="http://wiki.guildwars2.com/wiki";this.gw2DBUrl="http://www.gw2db.com";this.onClickGoTo="gw2DB";this.gw2DB_PopupHost="http://www.gw2db.com/{0}/{1}/tooltip?x&advanced=1&callback=?"};LoadResourceTask=function(a,c,b){this.data=null;this.ttl=b;this.version=c;this.gw2ResourceUrl=a;this.workFn=function(){var a=this,c=null,b=null;LocalStorageHelper.isSupported()&&(c=LocalStorageHelper.getObject(this.gw2ResourceUrl,this.version));null!==c?(a.status=2,a.data=c.data,a.successFn(a)):(b=(new JSONTask(this.gw2ResourceUrl)).success(function(c){a.data=c.data;LocalStorageHelper.putObject(a.gw2ResourceUrl,a.data,a.version,a.ttl);a.status=2;a.successFn(a)}).error(function(c,b){a.status=-1;a.errorFn(a,
b)}),b.doWork())}};LoadResourceTask.prototype=new Task;ResourceManager=function(){this.loadResource=function(a,c,b,d){this.getResourceList([{url:Gw2BBCodeConst.contentUrl+a,ver:c,ttl:b,data:null}],d)};this.loadResourceList=function(a,c){if(null===a||0===a.length)c(a);else{var b=new TaskList(30),d=0;b.resourceArr=a;b.callback=c;for(d=0;d<a.length;d++)b.addTask(new LoadResourceTask(a[d].url,a[d].ver||1,a[d].ttl||0));b.success(function(a){for(var c=0;c<a.tasks.length;c++)a.resourceArr[c].data=a.tasks[c].data;a.callback(a.resourceArr)}).error(function(a,
c){throw Error(c);});b.doWork()}};this.isUpToDate=function(a,c){return LocalStorageHelper.isSupported()&&LocalStorageHelper.isUpToDate(a,c)};this.isUpToDateArr=function(a){var c;for(c=0;c<a.length;c++)if(!this.isUpToDate(a[c].url,a[c].ver))return!1;return!0};this.getResource=function(a,c){return LocalStorageHelper.getObject(a,c)};this.putResource=function(a,c,b,d){LocalStorageHelper.putObject(a,c,b,d)}};
NoLocalStorageResourceManager=function(){this.resources={};this.getResource=function(a,c,b,d){this.getResourceList([{url:a,ver:c,ttl:b,data:null}],d)};this.getResourceList=function(){}};function LangPackHelper(){}LangPackHelper.getExprStr_profs=function(a,c){return LangPackHelper.getExprStr_generic(a,c,a.prof_s_langEn,"prof")};LangPackHelper.getExprStr_stances=function(a,c){return LangPackHelper.getExprStr_generic(a,c,a.stances_langEn,"stance")};LangPackHelper.getExprStr_types=function(a,c){return LangPackHelper.getExprStr_generic(a,c,a.types_langEn,"types")};
LangPackHelper.getExprStr_generic=function(a,c,b,d){for(var g=0,e=0,f=null,j="",g=0;g<b.length;g++)j+=b[g]+"|";for(g=0;g<a.lang_packs.length;g++)if(f=c.getResource(a.lang_packs[g].url,a.lang_packs[g].ver),null!==f)for(e=0;e<f.dicts[d].length;e++)-1===j.indexOf(f.dicts[d][e])&&(j+=f.dicts[d][e]+"|");return j.slice(0,j.length-1)};LangPackHelper.getProfIDFrom=function(a,c,b){return LangPackHelper.getMasterItemIDFor(a,c,b,a.prof_s_langEn,"prof")};
LangPackHelper.getStanceIDFrom=function(a,c,b){return LangPackHelper.getMasterItemIDFor(a,c,b,a.stances_langEn,"stance")};LangPackHelper.getTypeIDFrom=function(a,c,b){return LangPackHelper.getMasterItemIDFor(a,c,b,a.types_langEn,"types")};
LangPackHelper.getMasterItemIDFor=function(a,c,b,d,g){if(""===b)return"";var e=0,f=0,j=null;b=b.toLowerCase();for(e=0;e<d.length;e++)if(b===d[e].toLowerCase())return d[e];for(e=0;e<a.lang_packs.length;e++)if(j=c.getResource(a.lang_packs[e].url,a.lang_packs[e].ver),null!==j)for(f=0;f<j.dicts[g].length&&f<d.length;f++)if(b===j.dicts[g][f].toLowerCase())return d[f];return""};BBCodeDataEntry=function(a){this.name=a;this.nameObj=this.dataObj=null;this.isMacro=function(){return null!==this.dataObj&&"m"===this.dataObj.t};this.dataObjSet=[];this.fillWeaponSetData=function(a){if(this.isMacro())for(var b=0;b<this.dataObj.m.length;b++)this.dataObjSet.push(a.dataMap[this.dataObj.m[b]])}};
BBCodeData=function(a,c,b){this.gw2Global=a;this.resourceMgr=c;this.patternType=b;this.regex=this.orig="";this.entry2=this.entry1=null;this.isPrefixed=this.showAsText=!1;this.stance=this.options="";this.forcedIdx=-1;this.prof=this.type="";this.isWeaponSet=function(){return null!==this.entry1&&null!==this.entry2};this.toString=function(){return"regex: "+this.regex+"<br>name1: "+this.name1+"<br>name2: "+this.name2+"<br>showAsText: "+this.showAsText+"<br>isPrefixed: "+this.isPrefixed+"<br>stance: "+
this.stance+"<br>forcedIdx: "+this.forcedIdx+"<br>type: "+this.type+"<br>prof: "+this.prof+"<br><br>"};this.setStance=function(b){this.stance=LangPackHelper.getStanceIDFrom(a,c,b)};this.setType=function(b){this.type=LangPackHelper.getTypeIDFrom(a,c,b)};this.setProfession=function(b){this.prof=LangPackHelper.getProfIDFrom(a,c,b)};this.isCorrect=function(){return null===this.entry1&&null!==this.entry2||null!==this.entry1&&(null===this.entry1.dataObj||null===this.entry1.dataObj)||null!==this.entry2&&
(null===this.entry2.dataObj||null===this.entry2.dataObj)?!1:!0}};ClassicPattern=function(a,c){var b=RegExp("\\[([@^_]*)(gw2:)?(("+LangPackHelper.getExprStr_profs(a,c)+"):)?(("+LangPackHelper.getExprStr_types(a,c)+"):)?(.*?)(\\|(.*?))?(:("+LangPackHelper.getExprStr_stances(a,c)+"))?(\\.(\\d+))?\\]","gi");this.process=function(d){for(var g=[],e=b.exec(d),f=null;null!==e;)f=new BBCodeData(a,c,"gw2BBCode"),f.orig=e[0]||"",f.regex=RegExp((e[0]||"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),"gi"),f.showAsText=-1!==(e[1]||"").indexOf("@"),f.options=e[1]||"",f.isPrefixed=
"gw2:"===(e[2]||"").toLowerCase(),f.entry1=""!==(e[7]||"")?new BBCodeDataEntry(e[7]):null,f.entry2=""!==(e[9]||"")?new BBCodeDataEntry(e[9]):null,f.forcedIdx=Math.max(1,e[13]||1),f.setProfession(e[4]||""),f.setType(e[6]||""),f.setStance(e[11]||""),e=b.exec(d),g.push(f);return g}};TooltipMgr=function(a){var c=!1,b=null,d=-1,g="",e=null,f=this,j=[];this.initPopups=function(){b=document.createElement("div");b.setAttribute("id","db-tooltip-container");document.getElementsByTagName("body")[0].appendChild(b);this.registerTooltipsHandlers()};this.registerTooltipsHandlers=function(){jQuery(".gw2DBTooltip").each(function(){jQuery(this).unbind("mouseenter").mouseenter(m).unbind("mouseleave").mouseleave(function(){f.hideIn(150)})});jQuery(b).unbind("mouseenter").mouseenter(function(){c=
!1}).unbind("mouseleave").mouseleave(function(){f.hideIn(150)})};this.showPopup=function(a){c=!1;jQuery(b).css("display","none");jQuery(b).html(a);jQuery(".p-tooltip-image,.db-image").css("display","none");jQuery(b).css("top").replace("px","");a=jQuery(b).css("left").replace("px","");if(e){dispatcher=e;var f=Math.max(1,jQuery(dispatcher).offset().top+jQuery(dispatcher).height()-3);f>jQuery(window).height()+jQuery(window).scrollTop()-jQuery(b).outerHeight()-5&&(f=jQuery(dispatcher).offset().top+jQuery(dispatcher).height()-
k(dispatcher)-jQuery(b).outerHeight()-5);var j=jQuery(dispatcher).offset().left;j>jQuery(window).width()+jQuery(window).scrollLeft()-367&&(j=Math.min(a,jQuery(dispatcher).offset().left+jQuery(dispatcher).outerWidth()-367));jQuery(b).css("top",f);jQuery(b).css("left",j)}jQuery(b).css("display","inline")};this.hideIn=function(a){c||(c=!0,setTimeout(this.hidePopup,a))};this.hidePopup=function(a){if(a||c)c=!1,d=-1,g="",e=null,jQuery(b).css("display","none"),jQuery(b).html=""};var m=function(m){var k=
/gw2DB_(skills|tasks|traits|items|recipes|achievements|creatures|boons|conditions|guildupgrades)_(\d+)/.exec(this.getAttribute("class").toString());if(k&&(c=!1,!(d==k[2]&&g==k[1]&&(e===m.currentTarget||e===b)))){jQuery(b).css("top",m.pageY+10);jQuery(b).css("left",m.pageX+10);d=k[2];g=k[1];e=m.currentTarget;f.showPopup("<div class='db-tooltip'><div class='db-description' style='width: auto'>Loading..</div></div>");var p=k[1],r=k[2];(m=h(p,r))?f.showPopup(m):jQuery.getJSON(a.gw2DB_PopupHost.format(p,
r),function(a){var c=l(a);h(p,r)||j.push({id:r,type:p,data:c});-1==d||(d!=r||g!=p)||f.showPopup(l(a))})}},k=function(a){var c=jQuery(a).height();jQuery(a).children().each(function(){c=Math.max(c,k(this))});return c},h=function(a,c){for(var b=0;b<j.length;b++)if(j[b].id==c&&j[b].type==a)return j[b].data;return null},l=function(c){return c.Tooltip.replace(/<div class="db-image">\s+<img src=".*?\/>\s+<\/div>/g,"").replace('<a href="','<a href="'+a.gw2DBUrl)}};WeaponSwapHelper=function(a){this.registerWeaponSwapHandlers=function(){jQuery(".gw2BBCode_weaponSwap").unbind("click").click(c)};var c=function(c){"undefined"!==typeof window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges();jQuery(c.target.parentElement).find(".gw2BBCode_weaponSet").each(function(){jQuery(this).css("display","inline"==jQuery(this).css("display")?"none":"inline")});a.hidePopup(!0)}};PatternFinders=function(a){this.registeredPatterns=[];this.registerPattern=function(a){this.registeredPatterns.push(a)};this.find=function(c){for(var b=[],d=0,g=0,e,d=0;d<this.registeredPatterns.length;d++){e=this.registeredPatterns[d].process(c);for(g=0;g<e.length;g++)b.push(e[g])}for(d=0;d<b.length;d++)a.findDataAndNameFor(b[d]);return b}};Gw2DBCOMGenerator=function(a){this.getBBCode=function(a){var j="",m="";null!==a.entry1&&!a.entry1.isMacro()?j=c(a.entry1,a):null!==a.entry1&&a.entry1.isMacro()&&(j=b(a.entry1,a));null!==a.entry2&&!a.entry2.isMacro()?m=c(a.entry2,a):null!==a.entry2&&a.entry2.isMacro()&&(m=b(a.entry2,a));return""!==j&&""===m?j:""!==j&&""!==m?(a=""!==(m||""),"<div class='gw2BBCode_weaponSetWraper'>{0}<div class='gw2BBCode_weaponSet'>{1}</div>{2}</div>".format(a?"<div class='gw2BBCode_weaponSwap'></div>":"",j,a?"<div class='gw2BBCode_weaponSet' style='display:none;'>{0}</div>".format(m):
"")):a.orig};var c=function(a,c){var b=a.dataObj,k=e(b,a.nameObj.lang,"en");return d(b.id,k,b.t,g(k,b,c))},b=function(a,c){var b,k=[],h=null,l="",n="";for(b=0;b<a.dataObj.m.length;b++)h=a.dataObjSet[b],l=e(h,a.nameObj.lang,"en"),k.push(d(h.id,l,h.t,g(l,h,c)));for(b=0;b<k.length;b++)n+=k[b]+(c.showAsText&&b!==k.length-1?" ":"");return n},d=function(c,b,d,e){return"<a href='{0}' class='gw2DBTooltip gw2DB_{1}_{2}'>{3}</a>".format("gw2Wiki"===a.onClickGoTo?"{0}/{1}".format(a.gw2WikiUrl,b.replace(/\s/g,
"-").replace(/['"!]/g,"")):"gw2DB"===a.onClickGoTo?"{0}/{1}/{2}".format(a.gw2DBUrl,a.element_type[d],c):"#",a.element_type[d],c,e)},g=function(c,b,d){if(d.showAsText)return c;c=b.t;d=b.id;b="tr"===c?"<img src='{0}/{1}/{2}.png'>".format(a.imagesUrl,a.element_type[c],b.tr||""):"<img src='{0}/{1}/{2}.png'>".format(a.imagesUrl,a.element_type[c],d);return b},e=function(a,c,b){return(c=a.names[c])?c:a.names[b]||""}};HTMLProcessor=function(a,c){var b="html,head,style,title,link,meta,script,object,iframe,code,textarea,a",b=b+",";this.processAll=function(){this.processNode(document.body)};this.processNode=function(d){if(!(null===d||"undefined"==d)){d=d.childNodes;for(var g=0,e=null,f=null,g=0;g<d.length;g++)if(f=d[g],1===f.nodeType&&-1===(b+",").indexOf(f.nodeName.toLowerCase()+",")&&this.processNode(f),!(3!==f.nodeType||""===(f.data||"").trim()))if(e=c.find(f.data),0!==e.length){for(var j=a,m=f.parentNode,k=e.length,
h=f.data,l=0,n=null,n=l=null,l=0;l<k;l++)n=e[l],n.isCorrect()&&(h=h.replace(n.regex,j.getBBCode(n)));if(h!==f.data){l=document.createElement("div");n=document.createDocumentFragment();for(l.innerHTML=h;l.firstChild;)n.appendChild(l.firstChild);m.insertBefore(n,f);m.removeChild(f)}}}}};Gw2DataMap=function(a,c,b){this.dataMap={};this.nameMap={};var d=!0;this.init=function(b){var e=0;c.isUpToDate(a.main_pack.url,a.main_pack.ver)||(d=!1,b.push(a.main_pack));for(e=0;e<a.lang_packs.length;e++)c.isUpToDate(a.lang_packs[e].url,a.lang_packs[e].ver)||(d=!1,b.push(a.lang_packs[e]))};this.init(b);this.findDataAndNameFor=function(a){var c=null;null!==a.entry1&&(c=g(this,a.entry1.name,a),null!==c&&(a.entry1.dataObj=c.data,a.entry1.nameObj=c.name,a.entry1.fillWeaponSetData(this)));null!==a.entry2&&
(c=g(this,a.entry2.name,a),null!==c&&(a.entry2.dataObj=c.data,a.entry2.nameObj=c.name,a.entry2.fillWeaponSetData(this)))};this.fillGw2DataMap=function(){!0===d&&(this.dataMap=c.getResource("Gw2DataMap",1),this.nameMap=c.getResource("Gw2NameMap",1),d=null!==this.dataMap&&null!==this.nameMap);if(!d){var b,g,k=null,h,l;this.dataMap={};this.nameMap={};k=c.getResource(a.main_pack.url,a.main_pack.ver);for(b=0;b<k.length;b++)h=k[b],h.names={en:h.n},this.dataMap[h.id]=h,this.nameMap[e(h.n)]=this.nameMap[e(h.n)]||
[],this.nameMap[e(h.n)].push({id:h.id,n:h.n,lang:"en"});for(b=0;b<a.lang_packs.length;b++){k=c.getResource(a.lang_packs[b].url,a.lang_packs[b].ver);for(g=0;g<k.names.length;g++){h=k.names[g];if(null===(this.dataMap[h[0]]||null))console.log("ERROR: no data for id:{0}, name:{1} in langPack:{2}".format(h[0],h[1],k.lang)),this.dataMap[h[0]]={id:h[0],name:h[1],t:"?",names:{}};this.nameMap[e(h[1])]=this.nameMap[e(h[1])]||[];this.nameMap[e(h[1])].push({id:h[0],n:h[1],lang:k.lang});this.dataMap[h[0]].names[k.lang]=
h[1]}}for(l in this.nameMap)-1!==l.indexOf("gw2_")&&this.nameMap[l].sort(f);c.putResource("Gw2DataMap",this.dataMap,1,0);c.putResource("Gw2NameMap",this.nameMap,1,0);d=!0}};var g=function(a,c,b){var d,f,g=0,q=null,p=c.toLowerCase();if(""===c)return null;d=a.nameMap[e(c)]||null;if(null===d)return null;for(f=0;f<d.length;f++)if(d[f].n.toLowerCase()===p){q=a.dataMap[d[f].id]||null;if(null===q)throw Error("no data for "+c);if((""!==b.stance&&compareStrLow(b.stance,q.st||"")||""===b.stance)&&(""!==b.type&&
compareStrLow(b.type,q.t||"")||""===b.type)&&(""!==b.prof&&compareStrLow(b.prof,q.p||"")||""===b.prof)&&++g===b.forcedIdx)return{data:q,name:d[f]}}return null},e=function(a){return"gw2_"+a.substr(0,3).toLowerCase()},f=function(a,b){return a.n===b.n?0<a.id&&0<b.id||0>a.id&&0>b.id?a.id>b.id?-1:1:0<a.id?-1:1:a.n>b.n?1:-1}};Gw2BBCode=function(){var a=this,c=!1,b=!1;this.gw2Global=new Gw2BBCodeGlobal;this.weaponSwapHelper=this.contentGenerator=this.patternFinders=this.resourceMgr=this.tooltipMgr=this.gw2DataMap=this.processor=null;this.init=function(){if(LocalStorageHelper.isSupported())this.resourceMgr=new ResourceManager;else throw Error("Not implmeneted yet");var a=[];loadStyle(this.gw2Global.gw2_cssURL);loadStyle(this.gw2Global.popup_cssURL);this.tooltipMgr=new TooltipMgr(this.gw2Global,this.resourceMgr);this.gw2DataMap=
new Gw2DataMap(this.gw2Global,this.resourceMgr,a);this.patternFinders=new PatternFinders(this.gw2DataMap);this.contentGenerator=new Gw2DBCOMGenerator(this.gw2Global);this.processor=new HTMLProcessor(this.contentGenerator,this.patternFinders);this.weaponSwapHelper=new WeaponSwapHelper(this.tooltipMgr);this.resourceMgr.loadResourceList(a,d);jQuery(document).ready(g)};this.isLoadedAndReady=function(){return b&&c};this.registerAllHandlers=function(){this.isLoadedAndReady()&&(this.weaponSwapHelper.registerWeaponSwapHandlers(),
this.tooltipMgr.registerTooltipsHandlers())};var d=function(){b=!0;a.gw2DataMap.fillGw2DataMap();a.patternFinders.registerPattern(new ClassicPattern(a.gw2Global,a.resourceMgr));e()},g=function(){c=!0;e()},e=function(){a.isLoadedAndReady()&&(a.processor.processAll(),a.tooltipMgr.initPopups(),a.registerAllHandlers())}};window.gw2BBCode=new Gw2BBCode;window.gw2BBCode.init();})(window);
